// apps/api/src/routes/index.ts
import { Router } from "express";

// NOTE: Preserve your existing file names/import styles
import auth from "./auth.js";
import items from "./item.js";
import employees from "./employees.js";
import reports from "./reports.js";
import stockMovements from "./stockMovements.js";
import tableSales from "./tableSales.js";
import fieldDispatch from "./fieldDispatch.js";
import fieldReturn from "./fieldReturn.js";
import dailySalesShiftsCompat from "./dailySalesShiftsCompat.js";

// NEW
import salaryDeductions from "./salaryDeductions.js";
import payroll from "./payroll.js";

// NEW: shifts (daily sales shift open/close/cashup)
import shifts from "./shifts.js";

import { requireAdmin } from "../middlewares/auth.js";

const r = Router({ mergeParams: true });

/** Keep a single source of truth for the advertised mounts shown by /api/health */
const MOUNTS: string[] = [
  "/auth",
  "/items",
  "/employees",
  "/reports",
  "/stock-movements",
  "/table-sales",
  "/field-dispatch",
  "/field-return",
  "/salary-deductions",
  "/payroll",

  // NEW
  "/shifts",
  "/daily-sales/shifts",
  "/daily-sales/shifts/for-employee", // legacy compat
];

// --- Router-level health (verifies this router is mounted at /api) ---
r.get("/health", (_req, res) => {
  res.json({
    ok: true,
    service: "routes",
    ts: new Date().toISOString(),
    mounts: MOUNTS,
  });
});

// Public/auth
r.use("/auth", auth);

// Core admin-protected resources
r.use("/items", requireAdmin, items);
r.use("/employees", requireAdmin, employees);

// Reporting (admin-protected)
r.use("/reports", requireAdmin, reports);

// Sales & inventory flows (admin-protected)
r.use("/stock-movements", requireAdmin, stockMovements);
r.use("/table-sales", requireAdmin, tableSales);
r.use("/field-dispatch", requireAdmin, fieldDispatch);
r.use("/field-return", requireAdmin, fieldReturn);

// NEW: Payroll & Deductions (admin-protected)
r.use("/salary-deductions", requireAdmin, salaryDeductions);
r.use("/payroll", requireAdmin, payroll);

// NEW: Shifts (admin-protected; alias kept for daily-sales namespace)
r.use("/shifts", requireAdmin, shifts);
r.use("/daily-sales/shifts", requireAdmin, shifts);

// Legacy UI compatibility endpoints for Daily Sales
r.use("/daily-sales/shifts/for-employee", requireAdmin, dailySalesShiftsCompat);

export default r;
